---
title: "rgbif"
author: "LH"
date: "2023-11-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Packages
```{r}
library(here)
library(rgbif)
library(sf)
library(maps)
library(measurements)
library(tidyverse)
library(GGally)
library(ggridges)
library(lubridate)
```

Process the bounding box for SMF

top left:
 lat: 34.465504째
 long: -119.771787째
 
bottom right: 
  lat:  34.454424째
  long: -119.750857째
  
c(lng_min, lat_min, lng_max, lat_max)
st_bbox(xmin, ymin, xmax and ymax)
c(-119.750857, 34.454424, 119.771787, 34.465504)

For converting shp to wkt:
https://www.erikkusch.com/courses/gbif/datadiscovery/

Test your WKT object here: http://arthur-e.github.io/Wicket/sandbox-gmaps3.html
(Print your wkt object n)

```{r}
SMF_wkt <- gbif_bbox2wkt(maxx = -119.750857, miny = 34.454424, minx = -119.771787, maxy = 34.465504)
# SMF_wkt # print this, open the sand box link, copy the results into the box, then press Map It!
```

Import GBIF data for R
Class aves (birds) is taxon ID 212: https://www.gbif.org/species/212
```{r}
# download GBIF occurrence data for this species; this takes time if there are many data points!
gbif_data <- occ_data(hasCoordinate = TRUE, geometry = SMF_wkt, classKey = 212, year = "1990, 2023", limit = 30000)

# take a look at the downloaded data:
gbif_data

# if "Records found" is larger than "Records returned", you need to increase the 'limit' argument above -- see help(occ_data) for options and limitations
# as of 2023-11, there are ~14k records for birds in our region

# get the DOIs for citing these data properly
citation <- gbif_citation(gbif_data)

# get the columns that matter for mapping and cleaning the occurrence data
myspecies_coords <- gbif_data$data[ , c("decimalLongitude", "decimalLatitude", "order", "family", "genus", "species", "taxonomicStatus", "iucnRedListCategory", "individualCount", "eventDate", "year", "month", "day", "eventTime", "type", "recordedBy", "coordinateUncertaintyInMeters", "collectionCode", "references")]
#head(myspecies_coords)
```

Test data and display

```{r, eval = FALSE}
# convert frame points to decimal degrees
lat_minx <- -119.771787
long_maxy <- 34.465504
lat_maxx <- -119.750857
long_miny <- 34.454424

# map the occurrence data to test it
# if the map doesn't appear right at first, run this command again
map("world", xlim = c(lat_minx, lat_maxx), ylim = c(long_miny, long_maxy)) # set boundaries ("frame")
points(myspecies_coords[ , c("decimalLongitude", "decimalLatitude")], pch = ".") # add points
```

## Broken up by year and order

Summary statistics
```{r}
# individualCount column is the # of individuals per observation

# some observations say NA, and we will assume NA = 1
# head(myspecies_coords[is.na(myspecies_coords$individualCount) == TRUE,]) <- 1 # test to see how many are NA (returned 675)
myspecies_coords[is.na(myspecies_coords$individualCount) == TRUE,]$individualCount <- 1
# test that it worked (should return 1, not NA)
# min(myspecies_coords$individualCount, na.rm = FALSE)

myspecies_coords$month_abb <- factor(month.abb[myspecies_coords$month],levels=month.abb) # add month abbreviation

sum_order_year <- myspecies_coords %>% 
  group_by(order, year) %>% 
  summarise(total = sum(individualCount))
```

Visualize
```{r}
# bird order by year
ggplot(sum_order_year, aes(fill=order, y=total, x=year)) + 
    geom_bar(stat="identity")

# ridgeline plot
ggplot(myspecies_coords, aes(x = year, y = order, fill = order)) +
  geom_density_ridges() +
  theme_ridges() + 
  theme(legend.position = "none") +
  ylab("Order") +
  xlab("Year")

```

Plots in progress
```{r, eval = FALSE}

ggparcoord(myspecies_coords,
    columns = 1:4, groupColumn = 5
    ) 

# plot of lines and change over time relative to year 1

# parallel plot, order by year with families visible


```

## Broken up by month and order

```{r}
sum_order_month <- myspecies_coords %>% 
  filter(year > 2009) %>% # keep only records from 2010 and on
  group_by(order, month) %>% 
  summarise(total = sum(individualCount))

sum_order_month$month_abb <- factor(month.abb[sum_order_month$month],levels=month.abb) # add month abbreviation

```

Visualize 
```{r}
# bird order by month
ggplot(sum_order_month, aes(fill=order, y=total, x=month_abb)) + 
  geom_bar(stat="identity") 

# ridgeline plot
ggplot(myspecies_coords, aes(x = month, y = order, fill = order)) +
  geom_density_ridges() +
  theme_ridges() + 
  theme(legend.position = "none") +
  ylab("Order") +
  xlab("Month")

```

## Creating frame for new ecological data

```{r}
alltaxa <- myspecies_coords %>% 
  filter(taxonomicStatus == "ACCEPTED") %>% # remove synonymous taxa
  distinct(order, family, genus, species) 

# identify synonyms to look up and replace later
nrow(alltaxa)
length(unique(myspecies_coords$species)) # same value + number of removed synonyms
syntaxa <- myspecies_coords %>% 
  filter(taxonomicStatus == "SYNONYM") %>% # keep only synonymous taxa
  distinct(order, family, genus, species) 

```

Export csv to fill in guilds/ecology
```{r, eval = FALSE}
write.csv(alltaxa, file = here("data", "output", "alltaxa.csv"))
```

import data
```{r}
alltaxa_diet <- read.csv(here("data", "input", "alltaxa.csv"))
```

bind new categories to bird species, then to all observations
```{r}
dietkey <- alltaxa_diet %>% 
  select(species, diet) 

myspecies_coords <- left_join(myspecies_coords, dietkey, by = "species")
```


group_by and summarize
```{r}
sum_diet_month <- myspecies_coords %>% 
  filter(year > 2009) %>% # keep only records from 2010 and on
  group_by(diet, month) %>% 
  summarise(total = sum(individualCount))

sum_diet_month$month_abb <- factor(month.abb[sum_diet_month$month],levels=month.abb) # add month abbreviation
```

visualize
```{r}
# bird order by month
ggplot(sum_diet_month, aes(fill=diet, y=total, x=month_abb)) + 
  geom_bar(stat="identity") 

# ridgeline plot
ggplot(myspecies_coords, aes(x = month, y = diet, fill = diet)) +
  geom_density_ridges() +
  theme_ridges() + 
  theme(legend.position = "none") +
  ylab("Diet") +
  xlab("Month")

```

Question: How does sampling effort effect these results?

count up unique name-date combinations. For every person that made observations on a day, that is 1 sampling effort for that day. 
recordedBy = observer
eventDate (truncated to year-month-day) = day

type = PhysicalObject means museum specimen

```{r}
# count NAs in recordedBy (we want very few)
sum(is.na(myspecies_coords$recordedBy))

# remove all observations except for ebird (sampling effort varies between platforms/methods)
myspecies_ebird <- myspecies_coords[myspecies_coords$collectionCode == "EBIRD",]


# find observations per person to see if there are anomalies (note ebird observations will be high)
ebird_sumstats <- myspecies_ebird %>% 
  group_by(recordedBy, month) %>% 
  summarize(n()) 

ebird_sumstats_m <- ebird_sumstats %>% 
  group_by(month) %>% 
  summarize(count = n())

# graph
gg_effort <- ggplot(ebird_sumstats_m, aes(x = month, y = count)) +
  geom_col()

gg_effort
```

Now, let's compare the number of observations to the level of effort to see how correlated they are

All combined (no details)
```{r}
# rename datasets and columns
ebird_effort <- ebird_sumstats_m 
ebird_effort$effort <- ebird_effort$count

# keep month and effort columns
effort_combine <- ebird_effort %>% 
  select(month, effort) 
# remove some columns
effort_combine$order <- NULL
sum_order_month$month_abb <- NULL

effort_combine$month_abb <- factor(month.abb[effort_combine$month],levels=month.abb) # add month abbreviation

# summarize ebird data (by number of observations, not effort)
sum_month <- myspecies_ebird %>% 
  group_by(month_abb) %>% 
  summarise(observations = sum(individualCount))

# combine both
month_effort <- full_join(sum_month, effort_combine, by = c("month_abb"))

# interpolate (to make next plot nicer, or don't bother)
# use this: https://stackoverflow.com/questions/45227527/ggplot2-cannot-color-area-between-intersecting-lines-using-geom-ribbon

```

Plot and highlight diversions between effort and observations
```{r}
ggplot(data = month_effort) +
  geom_point(aes(x = month_abb, y = effort, color = "Sampling Effort")) +
  geom_line(aes(x = month_abb, y = effort, group = 1)) +
  geom_point(aes(x = month_abb, y = observations, color = "Observed")) +
  geom_line(aes(x = month_abb, y = observations, group = 1)) +
  geom_ribbon(aes(x = month_abb, ymin = effort, ymax = pmin(observations, effort)), fill = "red", group=1, alpha=0.3) +
  geom_ribbon(aes(x = month_abb, ymin = observations, ymax = pmin(effort, observations)), fill = "green", group=1, alpha=0.3)

```

For Order
```{r, eval = FALSE}
ebird_effort <- ebird_sumstats_m 
ebird_effort$total <- ebird_effort$count*100

effort_combine <- ebird_effort %>% 
  select(month, total) 

effort_combine$order <- NA
sum_order_month$month_abb <- NULL
effort_combine$tag <- "b"
sum_order_month$tag <- "a"

combine <- full_join(sum_order_month, effort_combine, by = c("month", "total", "order", "tag"))

combine$month_abb <- factor(month.abb[combine$month],levels=month.abb) # add month abbreviation

```

```{r}
ggplot() +
  geom_col(data = filter(combine, tag == "a"), aes(y = total, x = month_abb, fill = order), width = .3, just = 1) +
  geom_bar(data = filter(combine, tag == "b"), aes(x = month_abb, y = total, color = tag), stat='identity', width = .3, just = 0) +
  theme_bw() +
  xlab("Month") +
  ylab("Total Observations") +
  labs(fill = "Order", color = "Relative Sampling Effort") 

```

Sampling effort math
```{r}
month_effort$ratio <- month_effort$observations/month_effort$effort
effort_mean <- mean(month_effort$ratio)

# plot

# ratio
ggplot(month_effort) +
  geom_point(aes(x = month_abb, y = ratio)) +
  geom_line(aes(x = month_abb, y = ratio), group = 1) +
  theme_bw() +
  xlab("Month") +
  ylab("Observations per Sampling Event") +
  ylim(c(0, NA)) +
  geom_hline(yintercept = effort_mean, color = "blue")

# effort
ggplot(month_effort) +
  geom_point(aes(x = month_abb, y = effort)) +
  geom_line(aes(x = month_abb, y = effort), group = 1) +
  theme_bw() +
  xlab("Month") +
  ylab("Number of Sampling Events (effort)") 

# observations
ggplot(month_effort) +
  geom_point(aes(x = month_abb, y = observations)) +
  geom_line(aes(x = month_abb, y = observations), group = 1) +
  theme_bw() +
  xlab("Month") +
  ylab("Number of Observations") 


```

# Rare species